<!doctypehtml>
    <html lang="th">
    <meta charset="UTF-8">
    <meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover"
        name="viewport">
    <title>‡∏ô‡∏±‡∏î‡∏ß‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏≠‡∏≤‡∏£‡πå‡∏°‡∏ó‡∏µ‡πÄ‡∏ñ‡∏≠‡∏∞‡πÑ‡∏´‡∏ß‡πâ‡∏´‡∏•‡πà‡∏∞</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        :root {
            --primary: #4A90E2;
            --primary-dark: #357ABD;
            --accent: #FF6B6B;
            --text-main: #2C3E50;
            --text-secondary: #666;
            --glass-bg: rgba(255, 255, 255, 0.75);
            --glass-border: rgba(255, 255, 255, 0.9);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            --safe-area-top: env(safe-area-inset-top);
            --safe-area-bottom: env(safe-area-inset-bottom)
        }

        body {
            font-family: Kanit, sans-serif;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            background-color: #f0f4f8;
            color: var(--text-main);
            -webkit-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent
        }

        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: radial-gradient(circle at center, #dceefc, #bfdfff);
            pointer-events: none
        }

        .container {
            max-width: 550px;
            width: 100%;
            box-sizing: border-box;
            margin: 0 auto;
            position: relative;
            z-index: 1;
            padding: calc(20px + var(--safe-area-top)) 15px calc(20px + var(--safe-area-bottom)) 15px
        }

        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            padding: 25px 20px;
            border-radius: 24px;
            box-shadow: var(--glass-shadow);
            border: 1px solid var(--glass-border);
            margin-bottom: 20px;
            animation: slideUp .6s cubic-bezier(.2, .8, .2, 1)
        }

        h1 {
            text-align: center;
            color: var(--primary);
            margin: 0 0 15px 0;
            font-weight: 600;
            font-size: 1.6rem;
            text-shadow: 0 2px 4px rgba(255, 255, 255, .5)
        }

        label {
            font-size: .95rem;
            color: var(--text-main);
            margin-top: 15px;
            margin-bottom: 8px;
            display: block;
            font-weight: 500
        }

        .row-inputs {
            display: flex;
            gap: 10px;
            align-items: flex-end
        }

        input,
        select {
            width: 100%;
            padding: 12px 14px;
            margin-bottom: 5px;
            border: 1px solid rgba(74, 144, 226, .3);
            border-radius: 12px;
            font-family: Kanit;
            font-size: 16px;
            background-color: rgba(255, 255, 255, .6);
            transition: all .2s;
            box-sizing: border-box;
            color: var(--text-main);
            -webkit-appearance: none;
            appearance: none
        }

        input[type=date] {
            cursor: pointer;
            position: relative
        }

        select {
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%234A90E2%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right 1em top 50%;
            background-size: .8em auto;
            padding-right: 2.5em
        }

        input:focus,
        select:focus {
            border-color: var(--primary);
            outline: 0;
            background-color: #fff;
            box-shadow: 0 0 0 4px rgba(74, 144, 226, .15)
        }

        button {
            width: 100%;
            padding: 14px;
            margin-top: 20px;
            border: none;
            border-radius: 14px;
            font-family: Kanit;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: .2s;
            background: linear-gradient(135deg, var(--primary) 0, var(--primary-dark) 100%);
            color: #fff;
            box-shadow: 0 4px 15px rgba(74, 144, 226, .4);
            position: relative;
            overflow: hidden;
            -webkit-user-select: none
        }

        button:active {
            transform: scale(.97)
        }

        button:disabled {
            background: #bdc3c7;
            color: #7f8c8d;
            box-shadow: none;
            cursor: not-allowed;
            transform: none
        }

        button.cal-btn {
            background: linear-gradient(135deg, #2ecc71 0, #27ae60 100%);
            box-shadow: 0 4px 15px rgba(46, 204, 113, .4);
            margin-top: 15px
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 1.1rem;
            background: rgba(255, 255, 255, .4);
            padding: 8px;
            border-radius: 12px
        }

        .calendar-nav-btn {
            background: #fff;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            color: var(--primary);
            box-shadow: 0 2px 5px rgba(0, 0, 0, .05);
            margin: 0;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            text-align: center
        }

        .day-name {
            font-size: .8rem;
            color: #888;
            padding-bottom: 5px;
            font-weight: 500
        }

        .calendar-day {
            aspect-ratio: 1/1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            cursor: pointer;
            position: relative;
            background: rgba(255, 255, 255, .4);
            font-size: 1rem;
            transition: .1s
        }

        .calendar-day:active {
            transform: scale(.9)
        }

        .calendar-day.empty {
            background: 0 0;
            cursor: default
        }

        .calendar-day.has-event {
            background: #e8f8f5;
            color: #2ecc71;
            border: 1px solid #2ecc71;
            font-weight: 600
        }

        .calendar-day.selected {
            background: var(--primary);
            color: #fff;
            border: 1px solid var(--primary)
        }

        .date-details-box {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, .9);
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, .05);
            display: none;
            animation: slideUp .3s
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0
        }

        .detail-item:last-child {
            border-bottom: none
        }

        .footer-wrapper {
            text-align: center;
            margin-top: 30px;
            margin-bottom: 10px
        }

        .credit-badge {
            display: inline-block;
            background: rgba(255, 255, 255, .8);
            padding: 6px 16px;
            border-radius: 50px;
            font-size: .85rem;
            color: var(--text-main);
            box-shadow: 0 4px 10px rgba(0, 0, 0, .05);
            font-weight: 500;
            backdrop-filter: blur(4px)
        }

        .credit-badge span {
            color: #e74c3c
        }

        .warning-text {
            display: block;
            margin-top: 8px;
            font-size: .75rem;
            color: #888
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px)
            }

            to {
                opacity: 1;
                transform: translateY(0)
            }
        }

        @media (max-width:480px) {
            .container {
                width: 94%;
                padding-left: 10px;
                padding-right: 10px
            }

            .card {
                padding: 20px 15px
            }

            h1 {
                font-size: 1.4rem
            }

            .row-inputs.date-group {
                flex-direction: column;
                gap: 5px
            }

            .row-inputs.time-group {
                flex-direction: column;
                gap: 15px
            }

            .row-inputs.time-group>div {
                width: 100% !important
            }
        }
    </style>
    <div id="canvas-container"></div>
    <div class="container">
        <div class="card">
            <h1>üìÖ ‡∏ô‡∏±‡∏î‡∏ß‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏á</h1><label>üë§ ‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</label><input id="name"
                placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ‡∏≠‡∏≤‡∏£‡πå‡∏°‡∏™‡∏∏‡∏î‡∏´‡∏•‡πà‡∏≠)"><label>üóìÔ∏è ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á</label>
            <div class="row-inputs date-group"><input id="startDate" onclick="this.showPicker()" onkeydown="return!1"
                    type="date"><span
                    style="padding-bottom:12px;color:#888;font-size:.9rem;align-self:center">‡∏ñ‡∏∂‡∏á</span><input
                    id="endDate" onclick="this.showPicker()" onkeydown="return!1" type="date"></div><label>‚è∞ ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤
                (24 ‡∏ä‡∏°.)</label>
            <div class="row-inputs time-group">
                <div style="width:50%"><small style="color:var(--text-secondary)">‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà</small><select
                        id="startTime"></select></div>
                <div style="width:50%"><small style="color:var(--text-secondary)">‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤</small><select
                        id="endTime"></select></div>
            </div><button onclick="submitData()" id="submitBtn">üöÄ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </div>
        <div class="card">
            <h3>üóìÔ∏è ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏ß‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô</h3>
            <div id="loading" style="text-align:center;color:#666;padding:20px">
                <div style="font-size:2rem">‚è≥</div>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
            </div>
            <div id="calendar-wrapper" style="display:none">
                <div class="calendar-header"><button onclick="changeMonth(-1)" class="calendar-nav-btn">‚ùÆ</button><span
                        id="month-year-label"></span><button onclick="changeMonth(1)"
                        class="calendar-nav-btn">‚ùØ</button></div>
                <div class="calendar-grid">
                    <div class="day-name">‡∏≠‡∏≤</div>
                    <div class="day-name">‡∏à</div>
                    <div class="day-name">‡∏≠</div>
                    <div class="day-name">‡∏û</div>
                    <div class="day-name">‡∏û‡∏§</div>
                    <div class="day-name">‡∏®</div>
                    <div class="day-name">‡∏™</div>
                </div>
                <div class="calendar-grid" id="calendar-days"></div>
            </div>
            <div class="date-details-box" id="selectedDateDetails">
                <h4 id="detail-date-title" style="margin:0 0 10px 0;color:var(--primary)"></h4>
                <div id="detail-list"></div>
            </div><button onclick="findCommonTime()" class="cal-btn" id="summaryBtn">üîç ‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡∏±‡∏ô‡∏¢‡∏≠‡∏î‡∏Æ‡∏¥‡∏ï
                (‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</button>
            <div class="result-box" id="bestTime"
                style="display:none;margin-top:15px;padding:15px;background:rgba(232,248,245,.9);border-radius:10px;border:2px dashed #2ecc71;text-align:center">
            </div>
        </div>
        <div class="footer-wrapper">
            <div class="credit-badge">‚ö° Developed by<strong>Arm</strong><span>‚ù§Ô∏è</span></div><span
                class="warning-text">*‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡∏±‡∏ô‡∏¢‡∏≠‡∏î‡∏Æ‡∏¥‡∏ï ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ô‡∏∞‡∏à‡πä‡∏∞</span>
        </div>
    </div>
    <script>const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyNv4P-rNP8zrNZC7Lpjmq8cMpHbRUHE0iZijzDT7OhlRvrXc0i4zH6TgCc3Ttzgc69/exec';

        let isSubmitting = false;

        function initThreeJS() {
            const container = document.getElementById('canvas-container');
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            container.appendChild(renderer.domElement);

            const geometry = new THREE.BufferGeometry();
            const count = 1500;
            const positions = new Float32Array(count * 3);
            for (let i = 0; i < count * 3; i++) { positions[i] = (Math.random() - 0.5) * 20; }
            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));

            const material = new THREE.PointsMaterial({ size: 0.05, color: 0x4A90E2, transparent: true, opacity: 0.6, sizeAttenuation: true });
            const particles = new THREE.Points(geometry, material);
            scene.add(particles);
            camera.position.z = 5;

            function animate() {
                requestAnimationFrame(animate);
                particles.rotation.y += 0.001;
                particles.rotation.x += 0.0005;
                renderer.render(scene, camera);
            }
            animate();
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        window.onload = function () {
            initThreeJS();
            generateTimeOptions();
            loadData();
        };

        function generateTimeOptions() {
            const startSelect = document.getElementById('startTime');
            const endSelect = document.getElementById('endTime');
            let options = "";
            for (let i = 0; i < 24; i++) {
                for (let j = 0; j < 60; j += 30) {
                    let h = i.toString().padStart(2, '0');
                    let m = j.toString().padStart(2, '0');
                    let time = `${h}:${m}`;
                    options += `<option value="${time}">${time}</option>`;
                }
            }
            options += `<option value="00:00">00:00 (‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏∑‡∏ô)</option>`;
            startSelect.innerHTML = options;
            endSelect.innerHTML = options;
            startSelect.value = "19:00";
            endSelect.value = "00:30";
        }

        async function submitData() {
            if (isSubmitting) return;

            const name = document.getElementById('name').value;
            const sDate = document.getElementById('startDate').value;
            const eDate = document.getElementById('endDate').value;
            const sTime = document.getElementById('startTime').value;
            const eTime = document.getElementById('endTime').value;

            if (!name || !sDate || !eDate) return alert("‚ö†Ô∏è ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡∏™‡∏¥‡∏Ñ‡∏£‡πä‡∏≤‡∏ö‡∏ö ‡∏û‡∏±‡∏ö‡∏ú‡πà‡∏≤‡∏™‡∏¥");
            if (sDate > eDate) return alert("‚ö†Ô∏è ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏° ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î ‡∏Å‡∏£‡∏≠‡∏Å‡∏ú‡∏¥‡∏î ‡∏´‡∏£‡∏∑‡∏≠ ‡∏Å‡∏ß‡∏ô‡∏ï‡∏µ‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö‡πÄ‡∏ô‡∏µ‡πà‡∏¢‡∏¢‡∏¢");

            isSubmitting = true;
            const btn = document.getElementById('submitBtn');
            const originalText = btn.innerText;

            btn.innerHTML = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å... (‡∏´‡πâ‡∏≤‡∏°‡∏Å‡∏î‡∏ã‡πâ‡∏≥)";
            btn.disabled = true;

            let timeString = `${sTime} - ${eTime}`;

            // --- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö ---
            // ‡∏ï‡∏±‡∏î‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏≠‡∏≠‡∏Å ‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö range ‡πÄ‡∏™‡∏°‡∏≠
            let dateToSend = `${sDate} ‡∏ñ‡∏∂‡∏á ${eDate}`;
            // ---------------------

            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: name, date: dateToSend, timeSlot: timeString })
                });

                // Optimistic Update
                let userDates = getDates(sDate, eDate);
                userDates.forEach(dateStr => {
                    if (!processedEvents[dateStr]) processedEvents[dateStr] = [];
                    processedEvents[dateStr].push({ name: name, time: timeString });
                });

                renderCalendar(currentMonth, currentYear);
                document.getElementById('name').value = '';
                alert(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß! ‡∏Æ‡πä‡∏≤‡∏ü‡∏ü‡∏π‡πâ‡∏ß‡∏ß`);
                document.querySelector('.calendar-header').scrollIntoView({ behavior: 'smooth' });

            } catch (err) {
                console.error(err);
                alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ ‡∏Ç‡∏≠‡∏á‡∏ü‡∏£‡∏µ‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡πÉ‡∏à ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏´‡∏≤‡∏¢ ‡∏°‡∏±‡πâ‡∏á");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
                isSubmitting = false;
            }
        }

        function getDates(startDateStr, endDateStr) {
            let dates = [];
            let current = new Date(startDateStr);
            let end = new Date(endDateStr);
            current.setHours(0, 0, 0, 0);
            end.setHours(0, 0, 0, 0);
            while (current <= end) {
                let year = current.getFullYear();
                let month = (current.getMonth() + 1).toString().padStart(2, '0');
                let day = current.getDate().toString().padStart(2, '0');
                dates.push(`${year}-${month}-${day}`);
                current.setDate(current.getDate() + 1);
            }
            return dates;
        }

        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        window.allDataCache = [];
        let processedEvents = {};

        function loadData() {
            fetch(SCRIPT_URL)
                .then(res => res.json())
                .then(data => {
                    window.allDataCache = data;
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('calendar-wrapper').style.display = 'block';
                    processEventsData(data);
                    renderCalendar(currentMonth, currentYear);
                })
                .catch(err => {
                    document.getElementById('loading').innerText = "‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à üòÖ ‡∏¢‡∏¥‡πâ‡∏°‡πÅ‡∏´‡πâ‡∏á‡πÄ‡∏•‡∏¢ ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏π‡∏ó‡∏≥‡πÑ‡∏á‡∏î‡∏µ‡∏•‡∏∞‡∏ó‡∏µ‡∏ô‡∏µ‡πâ";
                });
        }

        function processEventsData(data) {
            processedEvents = {};
            data.forEach(row => {
                let rawDate = row[2];
                let name = row[1];
                let timeSlot = row[3];
                let dates = [];
                if (rawDate.includes(" ‡∏ñ‡∏∂‡∏á ")) {
                    let parts = rawDate.split(" ‡∏ñ‡∏∂‡∏á ");
                    dates = getDates(parts[0], parts[1]);
                } else {
                    dates = [rawDate];
                }
                dates.forEach(dateStr => {
                    if (!processedEvents[dateStr]) { processedEvents[dateStr] = []; }
                    processedEvents[dateStr].push({ name: name, time: timeSlot });
                });
            });
        }

        function renderCalendar(month, year) {
            const daysContainer = document.getElementById('calendar-days');
            const label = document.getElementById('month-year-label');
            daysContainer.innerHTML = "";

            const thaiMonths = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];
            label.innerText = `${thaiMonths[month]} ${year + 543}`;

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for (let i = 0; i < firstDay; i++) {
                let emptyDiv = document.createElement("div");
                emptyDiv.classList.add("calendar-day", "empty");
                daysContainer.appendChild(emptyDiv);
            }

            for (let day = 1; day <= daysInMonth; day++) {
                let dayDiv = document.createElement("div");
                dayDiv.classList.add("calendar-day");
                dayDiv.innerText = day;
                let dateKey = `${year}-${(month + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;

                if (processedEvents[dateKey]) {
                    dayDiv.classList.add("has-event");
                }

                dayDiv.onclick = () => {
                    document.querySelectorAll('.calendar-day').forEach(d => d.classList.remove('selected'));
                    dayDiv.classList.add('selected');
                    showDetails(dateKey, day, month, year);
                };
                daysContainer.appendChild(dayDiv);
            }
        }

        function showDetails(dateKey, day, month, year) {
            const detailBox = document.getElementById('selectedDateDetails');
            const title = document.getElementById('detail-date-title');
            const list = document.getElementById('detail-list');
            const thaiMonths = ["‡∏°.‡∏Ñ.", "‡∏Å.‡∏û.", "‡∏°‡∏µ.‡∏Ñ.", "‡πÄ‡∏°.‡∏¢.", "‡∏û.‡∏Ñ.", "‡∏°‡∏¥.‡∏¢.", "‡∏Å.‡∏Ñ.", "‡∏™.‡∏Ñ.", "‡∏Å.‡∏¢.", "‡∏ï.‡∏Ñ.", "‡∏û.‡∏¢.", "‡∏ò.‡∏Ñ."];

            title.innerText = `‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${day} ${thaiMonths[month]} ${year + 543}`;
            list.innerHTML = "";

            if (processedEvents[dateKey]) {
                processedEvents[dateKey].forEach(item => {
                    list.innerHTML += `
                        <div class="detail-item">
                            <span style="font-weight:600;">${item.name}</span>
                            <span style="color:#666; font-size:0.9em;">${item.time}</span>
                        </div>
                    `;
                });
                detailBox.style.display = 'block';
            } else {
                list.innerHTML = `<div style="text-align:center; color:#999; padding:10px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ üò¥</div>`;
                detailBox.style.display = 'block';
            }
        }

        function changeMonth(direction) {
            currentMonth += direction;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            } else if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderCalendar(currentMonth, currentYear);
            document.getElementById('selectedDateDetails').style.display = 'none';
        }

        // --- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ Fetch Data ‡πÉ‡∏´‡∏°‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏£‡∏∏‡∏õ ---
        async function findCommonTime() {
            const btn = document.getElementById('summaryBtn');
            const originalText = btn.innerHTML;
            const box = document.getElementById('bestTime');

            // 1. ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô Loading
            btn.innerHTML = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î...";
            btn.disabled = true;

            try {
                // 2. Fetch ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô loadData)
                const response = await fetch(SCRIPT_URL);
                const data = await response.json();

                // 3. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ global ‡πÅ‡∏•‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô
                window.allDataCache = data;
                processEventsData(data);
                renderCalendar(currentMonth, currentYear); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏à‡∏∏‡∏î‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏ö‡∏ô‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏î‡πâ‡∏ß‡∏¢

                // 4. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡∏±‡∏ô‡∏¢‡∏≠‡∏î‡∏Æ‡∏¥‡∏ï (Logic ‡πÄ‡∏î‡∏¥‡∏°)
                if (Object.keys(processedEvents).length === 0) {
                    alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏•‡∏¢‡∏à‡πâ‡∏≤‡∏≤‡∏≤‡∏≤");
                    box.style.display = 'none';
                    return;
                }

                let dateCounts = [];
                for (let dateKey in processedEvents) {
                    let people = processedEvents[dateKey];
                    let count = people.length;

                    let d = new Date(dateKey);
                    let prettyDate = d.toLocaleDateString('th-TH', {
                        weekday: 'short',
                        day: 'numeric',
                        month: 'short',
                        year: '2-digit'
                    });

                    dateCounts.push({
                        rawDate: dateKey,
                        displayDate: prettyDate,
                        count: count,
                        people: people
                    });
                }

                dateCounts.sort((a, b) => b.count - a.count);
                let maxVal = dateCounts[0].count;
                let winners = dateCounts.filter(d => d.count === maxVal);

                box.style.display = 'block';

                let html = `<div style="margin-bottom:10px; font-size:1.1rem;">üèÜ <b>‡∏ß‡∏±‡∏ô‡∏¢‡∏≠‡∏î‡∏Æ‡∏¥‡∏ï (‡∏ß‡πà‡∏≤‡∏á ${maxVal} ‡∏Ñ‡∏ô):</b></div>`;

                winners.forEach(w => {
                    let peopleList = w.people.map(p =>
                        `<li style="text-align:left; font-size:0.9rem; color:#555; margin-top:4px;">
                            <strong>${p.name}</strong> <span style="font-size:0.8em; color:#888;">(${p.time})</span>
                        </li>`
                    ).join("");

                    html += `
                        <div style="margin-top:15px; padding:15px; background:rgba(255,255,255,0.8); border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,0.05); border-left: 5px solid #2ECC71;">
                            <h3 style="margin:0 0 10px 0; color:#2C3E50;">${w.displayDate}</h3>
                            <ul style="margin:0; padding-left:20px;">
                                ${peopleList}
                            </ul>
                        </div>
                    `;
                });

                box.innerHTML = html;
                setTimeout(() => {
                    box.scrollIntoView({ behavior: "smooth", block: "start" });
                }, 100);

            } catch (err) {
                console.error(err);
                alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ‡∏Å‡∏π‡∏Å‡πá‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏¥‡∏î‡πÑ‡∏£‡∏Ç‡∏∂‡πâ‡∏ô ‡∏•‡∏≠‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏î‡∏π");
            } finally {
                // 5. ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏™‡∏†‡∏≤‡∏û‡πÄ‡∏î‡∏¥‡∏°
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }</script>