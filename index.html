<!doctype html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover"
        name="viewport">
    <title>‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à: ‡∏ï‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏´‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡πà‡∏≤‡∏á</title>
    <!-- Fonts: Orbitron ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ Sci-Fi, Kanit ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ -->
    <link
        href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&family=Orbitron:wght@400;700;900&display=swap"
        rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        :root {
            /* Guardians Palette */
            --neon-cyan: #00f3ff;
            --neon-magenta: #bc13fe;
            --deep-space: #0b0b14;

            /* Star Wars Palette */
            --saber-blue: #2ff;
            --saber-red: #f00;
            --star-gold: #ffe81f;

            /* Glass Vars */
            --glass-bg: rgba(20, 25, 40, 0.65);
            --glass-border: rgba(255, 255, 255, 0.1);
            --liquid-highlight: rgba(255, 255, 255, 0.2);
            --input-bg: rgba(0, 20, 40, 0.6);
        }

        body {
            font-family: 'Kanit', sans-serif;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            background-color: var(--deep-space);
            color: #fff;
            -webkit-tap-highlight-color: transparent;
            min-height: 100vh;
        }

        /* --- Three.js Background --- */
        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: radial-gradient(circle at center, #1a0b2e 0%, #000000 100%);
        }

        .container {
            max-width: 600px;
            width: 100%;
            margin: 0 auto;
            padding: 40px 20px;
            position: relative;
            z-index: 1;
            box-sizing: border-box;
        }

        /* --- Liquid Glass Card --- */
        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 25px;
            border: 1px solid var(--glass-border);
            box-shadow: 0 0 20px rgba(0, 243, 255, 0.1), inset 0 0 0 1px rgba(255, 255, 255, 0.05);
            position: relative;
            overflow: hidden;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.3s;
        }

        .card:hover {
            transform: translateY(-5px) scale(1.01);
            box-shadow: 0 15px 30px rgba(188, 19, 254, 0.2), 0 0 20px rgba(0, 243, 255, 0.2);
            border-color: var(--neon-cyan);
        }

        /* --- Typography --- */
        h1, h3, h4 {
            font-family: 'Kanit', sans-serif;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-align: center;
        }

        h1 {
            background: linear-gradient(to right, var(--neon-cyan), #fff, var(--neon-magenta));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 900;
            font-size: 1.8rem;
            margin-bottom: 25px;
            text-shadow: 0 0 10px rgba(0, 243, 255, 0.5);
            line-height: 1.3;
        }

        label {
            color: var(--neon-cyan);
            font-size: 1rem;
            margin-top: 15px;
            display: block;
            font-weight: 500;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        /* --- Holographic Inputs & Selects (UPDATED) --- */
        input,
        select {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 10px;
            background-color: var(--input-bg);
            border: 1px solid rgba(0, 243, 255, 0.3);
            border-radius: 8px;
            color: #fff;
            font-family: 'Kanit';
            font-size: 1rem;
            transition: all 0.3s ease;
            box-sizing: border-box;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
        }

        /* Custom Dropdown Arrow for Select */
        select {
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2300f3ff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 16px;
            padding-right: 40px; /* Make space for arrow */
            cursor: pointer;
        }

        /* Dropdown Options Styling (Chrome/Edge/Firefox) */
        select option {
            background-color: #0b0b14; /* Dark background for dropdown list */
            color: var(--neon-cyan);
            padding: 10px;
        }

        /* Input Date Styling */
        input[type="date"] {
            position: relative;
            cursor: pointer;
        }

        /* Style the Calendar Icon inside Input Date */
        ::-webkit-calendar-picker-indicator {
            filter: invert(1) brightness(1.5) drop-shadow(0 0 2px var(--neon-cyan));
            cursor: pointer;
            opacity: 0.8;
            transition: 0.3s;
        }

        ::-webkit-calendar-picker-indicator:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: var(--neon-magenta);
            box-shadow: 0 0 15px rgba(188, 19, 254, 0.4);
            background-color: rgba(0, 0, 0, 0.7);
            transform: scale(1.01);
        }

        input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .row-inputs {
            display: flex;
            gap: 15px;
        }

        /* --- Buttons --- */
        button {
            width: 100%;
            padding: 15px;
            margin-top: 25px;
            border: none;
            border-radius: 50px;
            font-family: 'Kanit', sans-serif;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            background: transparent;
            color: var(--neon-cyan);
            border: 2px solid var(--neon-cyan);
            transition: all 0.3s ease;
            z-index: 1;
            touch-action: manipulation;
        }

        button::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 0%;
            height: 100%;
            background: var(--neon-cyan);
            z-index: -1;
            transition: all 0.3s ease;
            box-shadow: 0 0 20px var(--neon-cyan);
        }

        button:hover {
            color: #000;
            letter-spacing: 1px;
            box-shadow: 0 0 30px var(--neon-cyan);
        }

        button:hover::before {
            width: 100%;
        }

        button:disabled {
            border-color: #555;
            color: #555;
            cursor: not-allowed;
            box-shadow: none;
        }

        button.cal-btn {
            border-color: var(--neon-magenta);
            color: var(--neon-magenta);
        }

        button.cal-btn::before {
            background: var(--neon-magenta);
            box-shadow: 0 0 20px var(--neon-magenta);
        }

        button.cal-btn:hover {
            color: #fff;
            box-shadow: 0 0 30px var(--neon-magenta);
        }

        /* --- Calendar Grid --- */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            background: rgba(0, 243, 255, 0.1);
            padding: 10px;
            border-radius: 10px;
            border: 1px solid rgba(0, 243, 255, 0.2);
        }

        .calendar-nav-btn {
            width: 35px;
            height: 35px;
            margin: 0;
            padding: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .calendar-nav-btn:hover {
            background: var(--neon-cyan);
            color: #000;
            letter-spacing: normal;
            box-shadow: 0 0 10px var(--neon-cyan);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            text-align: center;
        }

        .day-name {
            color: var(--neon-cyan);
            font-size: 0.9rem;
            font-weight: bold;
        }

        .calendar-day {
            aspect-ratio: 1/1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.05);
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1px solid transparent;
            user-select: none;
        }

        .calendar-day:hover {
            transform: scale(1.15) rotate(5deg);
            background: rgba(255, 255, 255, 0.15);
            border-color: var(--neon-magenta);
            box-shadow: 0 0 15px var(--neon-magenta);
            z-index: 10;
        }

        .calendar-day.has-event {
            border: 1px solid var(--neon-cyan);
            color: var(--neon-cyan);
            background: rgba(0, 243, 255, 0.1);
            box-shadow: 0 0 5px var(--neon-cyan);
        }

        .calendar-day.selected {
            background: var(--neon-magenta);
            color: #fff;
            box-shadow: 0 0 20px var(--neon-magenta);
            border-color: #fff;
            transform: scale(1.1);
        }

        /* --- Details & Results --- */
        .date-details-box,
        .result-box {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid var(--glass-border);
            border-left: 4px solid var(--neon-cyan);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            animation: slideIn 0.4s ease;
        }

        .result-box {
            border-left: 4px solid var(--neon-magenta);
            border-style: solid;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 8px 0;
        }

        .footer-wrapper {
            text-align: center;
            margin-top: 30px;
            opacity: 0.7;
        }

        .warning-text {
            color: var(--star-gold);
            font-size: 0.8rem;
            margin-top: 5px;
            display: block;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- Responsive Styles --- */
        @media (max-width: 768px) {
            .container { padding: 30px 15px; }
            .card { padding: 20px; }
            h1 { font-size: 1.5rem; }
            .calendar-grid { gap: 5px; }
            button { font-size: 1rem; padding: 12px; }
        }

        @media (max-width: 480px) {
            .row-inputs { flex-direction: column; gap: 10px; }
            .calendar-day { font-size: 0.9rem; border-radius: 6px; }
            .day-name { font-size: 0.8rem; }

            /* Better Touch Targets on Mobile */
            input, select {
                font-size: 16px; /* Prevents iOS Zoom */
                padding: 14px;
            }

            h1 { font-size: 1.3rem; margin-bottom: 20px; }
            .card { padding: 15px; margin-bottom: 20px; }
            .calendar-header { padding: 8px; }
            #month-year-label { font-size: 1rem !important; }
        }
    </style>
</head>

<body>

    <div id="canvas-container"></div>

    <div class="container">
        <!-- Input Card -->
        <div class="card">
            <h1>‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à: ‡∏ï‡∏≤‡∏°‡∏´‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡πà‡∏≤‡∏á</h1>

            <label>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</label>
            <input id="name" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏´‡∏±‡∏™ ‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡πâ‡∏≠‡∏á‡∏ã‡∏µ">

            <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£</label>
            <div class="row-inputs">
                <input id="startDate" type="date" onclick="this.showPicker()">
                <span style="align-self:center; color: var(--neon-cyan); font-weight:bold;">‡∏ñ‡∏∂‡∏á</span>
                <input id="endDate" type="date" onclick="this.showPicker()">
            </div>

            <label>‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡πÅ‡∏ï‡∏ô‡∏î‡πå‡∏ö‡∏≤‡∏¢</label>
            <div class="row-inputs">
                <div style="width:100%">
                    <small style="color:rgba(255,255,255,0.6); display:block; margin-bottom:5px;">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°</small>
                    <select id="startTime"></select>
                </div>
                <div style="width:100%">
                    <small style="color:rgba(255,255,255,0.6); display:block; margin-bottom:5px;">‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</small>
                    <select id="endTime"></select>
                </div>
            </div>

            <button onclick="submitData()" id="submitBtn">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÄ‡∏ß‡∏•‡∏≤</button>
        </div>

        <!-- Calendar Card -->
        <div class="card">
            <h3>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏£‡∏ß‡∏°</h3>

            <div id="loading" style="text-align:center; padding:20px; color: var(--neon-cyan)">
                <div style="font-size:2rem; animation: spin 2s linear infinite">‚öõÔ∏è</div>
                <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏°...</p>
            </div>

            <div id="calendar-wrapper" style="display:none">
                <div class="calendar-header">
                    <button onclick="changeMonth(-1)" class="calendar-nav-btn">‚ùÆ</button>
                    <span id="month-year-label"
                        style="font-family:'Kanit'; font-size: 1.2rem; color: var(--neon-cyan)"></span>
                    <button onclick="changeMonth(1)" class="calendar-nav-btn">‚ùØ</button>
                </div>

                <div class="calendar-grid">
                    <div class="day-name">‡∏≠‡∏≤.</div>
                    <div class="day-name">‡∏à.</div>
                    <div class="day-name">‡∏≠.</div>
                    <div class="day-name">‡∏û.</div>
                    <div class="day-name">‡∏û‡∏§.</div>
                    <div class="day-name">‡∏®.</div>
                    <div class="day-name">‡∏™.</div>
                </div>
                <div class="calendar-grid" id="calendar-days"></div>
            </div>

            <div class="date-details-box" id="selectedDateDetails" style="display:none">
                <h4 id="detail-date-title" style="margin:0 0 10px 0; color: var(--star-gold)"></h4>
                <div id="detail-list"></div>
            </div>

            <button onclick="findCommonTime()" class="cal-btn" id="summaryBtn">‡∏™‡πÅ‡∏Å‡∏ô‡∏´‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô</button>

            <div class="result-box" id="bestTime" style="display:none; text-align:center"></div>
        </div>

        <div class="footer-wrapper">
            <div style="font-family: 'Orbitron'; font-size: 0.8rem; color: #fff;">
                SYSTEMS BY <span style="color: var(--neon-cyan)">ARM</span>
            </div>
            <span class="warning-text">* ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ê‡∏≤‡∏ô‡∏ó‡∏±‡∏û</span>
        </div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyNv4P-rNP8zrNZC7Lpjmq8cMpHbRUHE0iZijzDT7OhlRvrXc0i4zH6TgCc3Ttzgc69/exec';
        let isSubmitting = false;

        // --- Three.js Background (Galaxy Particles) ---
        function initThreeJS() {
            const container = document.getElementById('canvas-container');
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });

            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            container.appendChild(renderer.domElement);

            // Create Star Particles
            const starsGeometry = new THREE.BufferGeometry();
            const starsCount = 2000;
            const posArray = new Float32Array(starsCount * 3);
            const colorsArray = new Float32Array(starsCount * 3);

            for (let i = 0; i < starsCount * 3; i += 3) {
                // Positions
                posArray[i] = (Math.random() - 0.5) * 30; // x
                posArray[i + 1] = (Math.random() - 0.5) * 30; // y
                posArray[i + 2] = (Math.random() - 0.5) * 30; // z

                // Colors (Mix of Cyan and Magenta)
                const isCyan = Math.random() > 0.5;
                colorsArray[i] = isCyan ? 0 : 0.7; // R
                colorsArray[i + 1] = isCyan ? 0.9 : 0.1; // G
                colorsArray[i + 2] = isCyan ? 1 : 1; // B
            }

            starsGeometry.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
            starsGeometry.setAttribute('color', new THREE.BufferAttribute(colorsArray, 3));

            const starsMaterial = new THREE.PointsMaterial({
                size: 0.03,
                vertexColors: true,
                transparent: true,
                opacity: 0.8,
                blending: THREE.AdditiveBlending
            });

            const starMesh = new THREE.Points(starsGeometry, starsMaterial);
            scene.add(starMesh);

            camera.position.z = 5;

            // Mouse Interaction
            let mouseX = 0;
            let mouseY = 0;
            let targetX = 0;
            let targetY = 0;

            const windowHalfX = window.innerWidth / 2;
            const windowHalfY = window.innerHeight / 2;

            document.addEventListener('mousemove', (event) => {
                mouseX = (event.clientX - windowHalfX);
                mouseY = (event.clientY - windowHalfY);
            });

            // Separate Auto-rotation from Mouse-interaction
            let autoRotX = 0;
            let autoRotY = 0;
            let smoothMouseX = 0;
            let smoothMouseY = 0;

            function animate() {
                requestAnimationFrame(animate);

                // 1. Auto Rotate (Everyone gets this)
                autoRotY += 0.0005;
                autoRotX += 0.0002;

                // 2. Mouse Calculations (Only affects values if mouse moves)
                targetX = mouseX * 0.001;
                targetY = mouseY * 0.001;

                // Smooth out mouse movement (lerp)
                smoothMouseX += 0.05 * (targetX - smoothMouseX);
                smoothMouseY += 0.05 * (targetY - smoothMouseY);

                // 3. Combine both
                starMesh.rotation.y = autoRotY + smoothMouseX;
                starMesh.rotation.x = autoRotX + smoothMouseY;

                renderer.render(scene, camera);
            }
            animate();

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        window.onload = function () {
            initThreeJS();
            generateTimeOptions();
            loadData();
        };

        // --- Logic (Translated) ---
        function generateTimeOptions() {
            const startSelect = document.getElementById('startTime');
            const endSelect = document.getElementById('endTime');
            let options = "";
            for (let i = 0; i < 24; i++) {
                for (let j = 0; j < 60; j += 30) {
                    let h = i.toString().padStart(2, '0');
                    let m = j.toString().padStart(2, '0');
                    let time = `${h}:${m}`;
                    options += `<option value="${time}">${time}</option>`;
                }
            }
            options += `<option value="00:00">00:00</option>`;
            startSelect.innerHTML = options;
            endSelect.innerHTML = options;
            startSelect.value = "19:00";
            endSelect.value = "00:30";
        }

        async function submitData() {
            if (isSubmitting) return;

            const name = document.getElementById('name').value;
            const sDate = document.getElementById('startDate').value;
            const eDate = document.getElementById('endDate').value;
            const sTime = document.getElementById('startTime').value;
            const eTime = document.getElementById('endTime').value;

            if (!name || !sDate || !eDate) return alert("‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£");
            if (sDate > eDate) return alert("‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡∏°‡∏¥‡∏ï‡∏¥‡πÄ‡∏ß‡∏•‡∏≤‡∏ö‡∏¥‡∏î‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ß (‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏±‡∏ô‡∏à‡∏ö)");

            isSubmitting = true;
            const btn = document.getElementById('submitBtn');
            const originalText = btn.innerText;

            btn.innerHTML = "üì° ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ê‡∏≤‡∏ô‡∏ó‡∏±‡∏û...";
            btn.disabled = true;

            let timeString = `${sTime} - ${eTime}`;
            let dateToSend = `${sDate} ‡∏ñ‡∏∂‡∏á ${eDate}`;

            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: name, date: dateToSend, timeSlot: timeString })
                });

                // Optimistic Update
                let userDates = getDates(sDate, eDate);
                userDates.forEach(dateStr => {
                    if (!processedEvents[dateStr]) processedEvents[dateStr] = [];
                    processedEvents[dateStr].push({ name: name, time: timeString });
                });

                renderCalendar(currentMonth, currentYear);
                document.getElementById('name').value = '';
                alert(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ñ‡∏π‡∏Å‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß`);
                document.querySelector('.calendar-header').scrollIntoView({ behavior: 'smooth' });

            } catch (err) {
                console.error(err);
                alert("‚ùå ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
                isSubmitting = false;
            }
        }

        function getDates(startDateStr, endDateStr) {
            let dates = [];
            let current = new Date(startDateStr);
            let end = new Date(endDateStr);
            current.setHours(0, 0, 0, 0);
            end.setHours(0, 0, 0, 0);
            while (current <= end) {
                let year = current.getFullYear();
                let month = (current.getMonth() + 1).toString().padStart(2, '0');
                let day = current.getDate().toString().padStart(2, '0');
                dates.push(`${year}-${month}-${day}`);
                current.setDate(current.getDate() + 1);
            }
            return dates;
        }

        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        window.allDataCache = [];
        let processedEvents = {};

        function loadData() {
            fetch(SCRIPT_URL)
                .then(res => res.json())
                .then(data => {
                    window.allDataCache = data;
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('calendar-wrapper').style.display = 'block';
                    processEventsData(data);
                    renderCalendar(currentMonth, currentYear);
                })
                .catch(err => {
                    document.getElementById('loading').innerHTML = "<span style='color:red'>‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏Ç‡∏≤‡∏î‡∏´‡∏≤‡∏¢ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà...</span>";
                });
        }

        function processEventsData(data) {
            processedEvents = {};
            data.forEach(row => {
                let rawDate = row[2];
                let name = row[1];
                let timeSlot = row[3];
                let dates = [];
                if (rawDate.includes(" ‡∏ñ‡∏∂‡∏á ")) {
                    let parts = rawDate.split(" ‡∏ñ‡∏∂‡∏á ");
                    dates = getDates(parts[0], parts[1]);
                } else {
                    dates = [rawDate];
                }
                dates.forEach(dateStr => {
                    if (!processedEvents[dateStr]) { processedEvents[dateStr] = []; }
                    processedEvents[dateStr].push({ name: name, time: timeSlot });
                });
            });
        }

        function renderCalendar(month, year) {
            const daysContainer = document.getElementById('calendar-days');
            const label = document.getElementById('month-year-label');
            daysContainer.innerHTML = "";

            const thaiMonths = [
                "‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô",
                "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"
            ];

            label.innerText = `${thaiMonths[month]} ${year}`;

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for (let i = 0; i < firstDay; i++) {
                let emptyDiv = document.createElement("div");
                emptyDiv.classList.add("calendar-day", "empty");
                daysContainer.appendChild(emptyDiv);
            }

            for (let day = 1; day <= daysInMonth; day++) {
                let dayDiv = document.createElement("div");
                dayDiv.classList.add("calendar-day");
                dayDiv.innerText = day;
                let dateKey = `${year}-${(month + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;

                if (processedEvents[dateKey]) {
                    dayDiv.classList.add("has-event");
                }

                dayDiv.onclick = () => {
                    document.querySelectorAll('.calendar-day').forEach(d => d.classList.remove('selected'));
                    dayDiv.classList.add('selected');
                    showDetails(dateKey, day, month, year);
                };
                daysContainer.appendChild(dayDiv);
            }
        }

        function showDetails(dateKey, day, month, year) {
            const detailBox = document.getElementById('selectedDateDetails');
            const title = document.getElementById('detail-date-title');
            const list = document.getElementById('detail-list');
            const thaiMonthsShort = ["‡∏°.‡∏Ñ.", "‡∏Å.‡∏û.", "‡∏°‡∏µ.‡∏Ñ.", "‡πÄ‡∏°.‡∏¢.", "‡∏û.‡∏Ñ.", "‡∏°‡∏¥.‡∏¢.", "‡∏Å.‡∏Ñ.", "‡∏™.‡∏Ñ.", "‡∏Å.‡∏¢.", "‡∏ï.‡∏Ñ.", "‡∏û.‡∏¢.", "‡∏ò.‡∏Ñ."];

            title.innerText = `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${day} ${thaiMonthsShort[month]} ${year}`;
            list.innerHTML = "";

            if (processedEvents[dateKey]) {
                processedEvents[dateKey].forEach(item => {
                    list.innerHTML += `
                        <div class="detail-item">
                            <span style="font-weight:600; color:#fff;">${item.name}</span>
                            <span style="color:var(--neon-cyan); font-size:0.9em;">${item.time}</span>
                        </div>
                    `;
                });
                detailBox.style.display = 'block';
            } else {
                list.innerHTML = `<div style="text-align:center; color:#888; padding:10px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</div>`;
                detailBox.style.display = 'block';
            }
        }

        function changeMonth(direction) {
            currentMonth += direction;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            } else if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderCalendar(currentMonth, currentYear);
            document.getElementById('selectedDateDetails').style.display = 'none';
        }

        async function findCommonTime() {
            const btn = document.getElementById('summaryBtn');
            const originalText = btn.innerHTML;
            const box = document.getElementById('bestTime');

            btn.innerHTML = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πÅ‡∏Å‡∏ô...";
            btn.disabled = true;

            try {
                const response = await fetch(SCRIPT_URL);
                const data = await response.json();

                window.allDataCache = data;
                processEventsData(data);
                renderCalendar(currentMonth, currentYear);

                if (Object.keys(processedEvents).length === 0) {
                    alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÄ‡∏ã‡∏Å‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ");
                    box.style.display = 'none';
                    return;
                }

                let dateCounts = [];
                for (let dateKey in processedEvents) {
                    let people = processedEvents[dateKey];
                    let count = people.length;
                    let d = new Date(dateKey);
                    let prettyDate = d.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: 'numeric' });

                    dateCounts.push({
                        rawDate: dateKey,
                        displayDate: prettyDate,
                        count: count,
                        people: people
                    });
                }

                dateCounts.sort((a, b) => b.count - a.count);
                let maxVal = dateCounts[0].count;
                let winners = dateCounts.filter(d => d.count === maxVal);

                box.style.display = 'block';

                let html = `<div style="margin-bottom:10px; font-size:1.1rem; color: var(--star-gold)">üèÜ <b>‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (${maxVal} ‡∏Ñ‡∏ô):</b></div>`;

                winners.forEach(w => {
                    let peopleList = w.people.map(p =>
                        `<li style="text-align:left; font-size:0.9rem; color:#ccc; margin-top:4px;">
                            <strong style="color: var(--neon-cyan)">${p.name}</strong> <span style="font-size:0.8em; color:#888;">(${p.time})</span>
                        </li>`
                    ).join("");

                    html += `
                        <div style="margin-top:15px; padding:15px; background:rgba(255,255,255,0.05); border-radius:12px; border-left: 5px solid var(--neon-magenta);">
                            <h3 style="margin:0 0 10px 0; color:#fff;">${w.displayDate}</h3>
                            <ul style="margin:0; padding-left:20px;">
                                ${peopleList}
                            </ul>
                        </div>
                    `;
                });

                box.innerHTML = html;
                setTimeout(() => {
                    box.scrollIntoView({ behavior: "smooth", block: "start" });
                }, 100);

            } catch (err) {
                console.error(err);
                alert("‚ùå ‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
    </script>
</body>

</html>